<!DOCTYPE html>
<html lang="en">
    <head>
        <title>CS4241 Assignment 2</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" type="text/css" href="css/style.css" />
    </head>

    <body>
        <div class="flex-container">
            <div>
                <form action="">
                    <fieldset>
                        TV show name<input
                            type="text"
                            id="show"
                            value="My TV show"
                        /><br />
                        Number of seasons<input
                            type="number"
                            id="seasons"
                            value="4"
                        /><br />
                        Episodes per season<input
                            type="number"
                            id="eps"
                            value="13"
                        /><br />
                        Duration of an episode (in minutes)<input
                            type="number"
                            id="duration"
                            value="45"
                        /><br />
                        <!-- Derived attribute: Total episodes and/or total time to watch the whole show -->
                        <button id="submit">Submit</button>
                    </fieldset>
                </form>
            </div>
            <div id="results">RESULTS</div>
        </div>
    </body>

    <script>
        const submit = function (e) {
            e.preventDefault();

            const show = document.querySelector("#show"),
                seasons = document.querySelector("#seasons"),
                eps = document.querySelector("#eps"),
                duration = document.querySelector("#duration");

            const json = {
                show: show.value,
                seasons: seasons.value,
                eps: eps.value,
                duration: duration.value,
            };
            const body = JSON.stringify(json);

            fetch("/submit", {
                method: "POST",
                body,
            }).then(function (response) {
                res = response.json(); // read as JSON
                const checkPromise = () => {
                    res.then((result) => {
                        // on promise fulfillment, return the promise
                        console.log(result);
                        handleResults(result);
                    }).catch((err) => {
                        console.error("Error: " + err); // otherwise log an error
                    });
                };
                checkPromise();
            });

            // fetch( '/submit' {
            //     method: "POST",
            //     body,
            // })
            // .then( response => response.json() )
            // .then ( json => {
            //     json.forEach(item => {
            //         const p = document.createElement('p');
            //         p.innerText = JSON.stringify(item);
            //         document.body.appendChild(p);
            //     })
            // });
            // return false;
            // }

            return false;
        };

        const remove = function (entryToRemove) {
            console.log("Removing the entry");
            console.log(entryToRemove);
            // e.preventDefault();

            const show = document.querySelector("#show"),
                seasons = document.querySelector("#seasons"),
                eps = document.querySelector("#eps"),
                duration = document.querySelector("#duration");

            const json = {
                show: show.value,
                seasons: seasons.value,
                eps: eps.value,
                duration: duration.value,
            };
            const body = JSON.stringify(json);

            fetch("/remove", {
                method: "POST",
                body,
            })
                .then((response) => response.json())
                .then((json) => {
                    json.forEach((item) => {
                        console.log(item);
                    });
                });

            return false;
        };

        window.onload = function () {
            const button = document.getElementById("submit");
            button.onclick = submit;
        };

        function handleResults(resultArr) {
            let resultStr =
                "<table><tr><th>TV Show</th><th>Seasons</th><th>Episodes Per Season</th><th>Duration of an Episode (Minutes)</th><th>Time Needed to Binge-Watch Full Show (Hours)</th><th>Remove</th></tr>";
            let parsedJson;
            for (let i = 0; i < resultArr.length; i++) {
                resultStr += "<tr>";
                parsedJson = resultArr[i];
                console.log(parsedJson);
                Object.keys(parsedJson).forEach(
                    (item) => (resultStr += "<td>" + parsedJson[item] + "</td>")
                );
                resultStr +=
                    "<td><button onclick='remove(" + i + ")'>Remove Entry</button></td>";
                resultStr += "</tr>";
            }
            resultStr += "</table>";
            document.getElementById("results").innerHTML = resultStr;
        }
    </script>
</html>
